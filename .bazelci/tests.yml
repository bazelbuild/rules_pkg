# These tests check the run-time behavior under various combinations
#
# - Tests: behavior only. release tools are in the integration tests
# - Platforms: ubuntu, centos, macos, windows
# - bzlmod enabled or not
# - bazel: LTS-1, LTS, latest
#
#


common: &common
  working_directory: ..

nobzlmod: &nobzlmod
  build_flags:
    - "--noenable_bzlmod"

#
# Groups of tests, by platform
#

# rpmbuild(8) is not available or installed on most platforms
default_tests: &default_tests
  test_targets:
    - "//pkg/..."
    - "//tests/..."
    - "//toolchains/..."
    - "-//tests/rpm/..."
    - "-//pkg/legacy/tests/rpm/..."

default_tests_with_rpm: &default_tests_with_rpm
  test_targets:
    - "//pkg/..."
    - "//tests/..."
    - "//toolchains/..."

win_tests: &win_tests
  test_flags:
    - "--test_tag_filters=-nowindows"
  build_flags:
    - "--build_tag_filters=-nowindows"
  test_targets:
    - "//pkg/..."
    - "//tests/..."
    - "//toolchains/..."
    # rpmbuild(8) is not supported on Windows
    - "-//tests/rpm/..."
    - "-//pkg/legacy/tests/rpm/..."

#
# Common features and tests by platform
#
ubuntu2204: &ubuntu
  platform: ubuntu2204
  <<: *common
  <<: *default_tests_with_rpm
  shell_commands:
    - sudo apt-get update
    - sudo apt-get install -y rpm elfutils  # for rpmbuild & eu-strip

centos7: &centos
  platform: centos7_java11_devtoolset10
  <<: *common
  <<: *default_tests_with_rpm

macos: &macos
  platform: macos
  <<: *common
  <<: *default_tests

windows: &windows
  platform: windows
  <<: *common
  <<: *win_tests

#
# Finally, the cross product of bazel releases X platforms
#
tasks:
  ub_head:
    name: ub_head
    bazel: latest
    <<: *ubuntu

  ub_lts:
    name: ub_lts
    bazel: latest
    <<: *ubuntu

  ub_lts_nobzlmod:
    name: ub_lts_nobzlmod
    bazel: latest
    <<: *ubuntu
    <<: *nobzlmod

  ub_lts1_nobzlmod:
    name: ub_lts1_nobzlmod
    bazel: latest-1
    <<: *ubuntu
    <<: *nobzlmod

  cent_lts:
    name: cent_lts
    bazel: latest
    <<: *centos

  mac_head:
    name: mac_head
    bazel: latest
    <<: *macos

  mac_lts:
    name: mac_lts
    bazel: latest
    <<: *macos

  mac_lts_nobzlmod:
    name: mac_lts_nobzlmod
    bazel: latest
    <<: *macos
    <<: *nobzlmod

  win_head:
    name: win_head
    bazel: latest
    <<: *windows

  win_lts:
    name: win_lts
    bazel: latest
    <<: *windows

  win_lts_nobzlmod:
    name: win_lts_nobzlmod
    bazel: latest
    <<: *windows
    <<: *nobzlmod
